import { kv } from '@vercel/kv';
import fs from 'fs/promises';
import path from 'path';
import type { AppState, Recommendation, SurveyState } from './types';

const defaultPrompts: Record<string, string> = {
  getChatPrompt: `?¹ì‹ ?€ ê³¡ë¬¼ ì¶”ì²œ ì±—ë´‡???€???”ì§„?…ë‹ˆ?? ??ƒ **? ìš”??JSON**?¼ë¡œë§??µí•´???˜ë©°, ì¶œë ¥ ?¤í‚¤ë§ˆëŠ” ?„ë˜?€ ?™ì¼?´ì•¼ ?©ë‹ˆ??

{
  "appState": {
    "survey": {
      "purpose": "string",
      "texture": "string",
      "avoid_or_allergy": ["string", ...]
    },
    "own_grains": ["string", ...]
  },
  "isComplete": false,
  "message": {
    "content": "string",
    "quick_replies": ["string", ...]
  }
}

ì»¨í…?¤íŠ¸
- ?„ì¬ ?íƒœ(appState): {{appState}}
- ?¬ìš©??ë©”ì‹œì§€: {{message}}

ê·œì¹™
1. ë©”ì‹œì§€?ì„œ ???•ë³´ë¥?ì¶”ì¶œ??appStateë¥?ê°±ì‹ ?©ë‹ˆ?? ?´ì „ ê°’ì´ ?ˆê³  ???•ë³´ê°€ ?†ìœ¼ë©?ê¸°ì¡´ ê°’ì„ ? ì??©ë‹ˆ??
2. 'purpose'?€ 'texture'ê°€ ëª¨ë‘ ì±„ì›Œì§€ë©?'isComplete'ë¥?trueë¡??¤ì •?©ë‹ˆ??
3. 'message.content'?ëŠ” ì±—ë´‡???¬ìš©?ì—ê²?ì¤??œêµ­???µë??? 'quick_replies'?ëŠ” ?„ì† ì§ˆë¬¸???„ì?????ì§§ì? ? íƒì§€ë¥?0~4ê°??£ìŠµ?ˆë‹¤.
4. **JSON ?´ì™¸???ìŠ¤?¸ë? ?¬í•¨?˜ì? ë§ˆì‹­?œì˜¤.**`,
  getRecommendationPrompt: `?¹ì‹ ?€ ?ì–‘??ê²?ê³¡ë¬¼ ë°°í•© ?„ë¬¸ê°€?…ë‹ˆ?? ?¬ìš©?ì˜ ?íƒœë¥?ë°”íƒ•?¼ë¡œ ?„ë˜ JSON êµ¬ì¡°ë§Œì„ ì¶œë ¥?˜ì„¸??

?…ë ¥ ?íƒœ:
{{appState}}

ì¶œë ¥ JSON:
{
  "recommendation": {
    "mode": "own_only|hybrid|catalog",
    "blend": [
      { "ê³¡ë¬¼": "string", "ë¹„ìœ¨": number }
    ],
    "reasons": ["string", ...]
  }
}

ê·œì¹™
1. ëª¨ë“œ ? íƒ: ë³´ìœ  ê³¡ë¬¼???ˆìœ¼ë©?hybridë¥??°ì„  ê³ ë ¤?˜ê³ , ?†ìœ¼ë©?catalog, ëª¨ë“  ê³¡ë¬¼??ì¶©ë¶„?˜ë©´ own_only.
2. blend??2~5ê°?ê³¡ë¬¼ë¡?êµ¬ì„±?˜ê³  ë¹„ìœ¨ ?©ì´ 100???˜ê²Œ ?˜ì‹­?œì˜¤.
3. 'avoid_or_allergy'???¬í•¨??ê³¡ë¬¼?€ ì¶”ì²œ?˜ì? ë§ˆì‹­?œì˜¤.
4. reasons?ëŠ” ì¶”ì²œ ê·¼ê±°ë¥?2~3ê°??œêµ­??ë¬¸ì¥?¼ë¡œ ?‘ì„±?©ë‹ˆ??`,
  getOptimizerPrompt: `?¹ì‹ ?€ ?„ë¡¬?„íŠ¸ ?”ì??ˆì–´?…ë‹ˆ?? ?„ë˜ ?„ë¡¬?„íŠ¸ë¥?ë¶„ì„????ëª…í™•?˜ê³  êµ¬ì¡°?”ëœ ë²„ì „???œì‹œ?˜ì„¸?? ì¶œë ¥?€ **ë§ˆí¬?¤ìš´ ?¹ì? JSON???„ë‹Œ ?œìˆ˜ ?ìŠ¤??*ë¡????„ë¡¬?„íŠ¸ë§??¬í•¨?´ì•¼ ?©ë‹ˆ??

?ë³¸ ?„ë¡¬?„íŠ¸:
---
{{prompt}}
---

ê°œì„  ì§€ì¹?1. ??• , ?…ë ¥, ì¶œë ¥, ?œì•½ ì¡°ê±´??ëª…í™•??êµ¬ë¶„?©ë‹ˆ??
2. LLM???°ë¼????êµ¬ì¡°(?¹íˆ JSON)ê°€ ?ˆë‹¤ë©?ë°˜ë“œ??"JSON"?´ë¼???¨ì–´?€ ?ˆì‹œë¥??¬í•¨?©ë‹ˆ??
3. ë¶ˆí•„?”í•˜ê²??¥í™©???œí˜„?€ ì¤„ì´ê³? ì¤‘ìš”??ê·œì¹™?€ ë²ˆí˜¸ ë§¤ê¸°ê±°ë‚˜ ë³¼ë“œ ì²˜ë¦¬ ì§€?œë? ì¶”ê??©ë‹ˆ??`,
  getExtractorPrompt: `?¹ì‹ ?€ '?¤ë¬¸ ì¶”ì¶œê¸??…ë‹ˆ?? ?¬ìš©?ì˜ ?œêµ­???…ë ¥ê³?ê¸°ì¡´ ?íƒœë¥?ë°”íƒ•?¼ë¡œ ?•ë³´ë¥?ì¶”ì¶œ?˜ê³ , ì§€?•ëœ **JSON ?•ì‹**?¼ë¡œë§??µí•´???©ë‹ˆ??

[ì»¨í…?¤íŠ¸]
- ?„ì¬ ?íƒœ: {{appState}}

[?¬ìš©??ë©”ì‹œì§€]
---
{{message}}
---

[?„ë“œ ?•ì˜]
- purpose(ëª©ì ): '?ˆë‹¹ê´€ë¦? | '?¤ì´?´íŠ¸' | '?¨ë°±ì§ˆë³´ê°? | '?¥ê±´ê°? | 'ê¸°í?' | 'ë¯¸ì •'
- texture(?ê°): 'ë¶€?œëŸ¬?€' | 'ì«€?í•¨' | 'ê³ ìŠ¬ê³ ìŠ¬' | 'ë¯¸ì •'
- avoid_or_allergy: ê¸°í”¼ ê³¡ë¬¼ ë°°ì—´ (?? ["ë³´ë¦¬"])
- own_grains: ë³´ìœ  ê³¡ë¬¼ ë°°ì—´

[ê·œì¹™]
1. ê¸°ì¡´ ê°’ì´ ?ˆìœ¼ë©?? ì??˜ê³ , ë¹„ì–´ ?ˆê±°??'ë¯¸ì •'????ª©ë§????•ë³´ë¡?ì±„ì›?ˆë‹¤. ë°°ì—´?€ ?©ì§‘????ì¤‘ë³µ ?œê±°.
2. purpose?€ texture ì¤?ë¹„ì–´ ?ˆëŠ” ?„ë“œ??'missing_slots'??ì¶”ê??©ë‹ˆ??
3. ????ì±„ì›Œì§€ë©?'is_complete=true'.
4. ???•ë³´ê°€ ?˜ë‚˜?¼ë„ ?ˆìœ¼ë©?'has_new_info=true'.

[ì¶œë ¥ JSON]
{
  "updated_state": {
    "survey": {
      "purpose": "string",
      "texture": "string",
      "avoid_or_allergy": []
    },
    "own_grains": []
  },
  "is_complete": false,
  "missing_slots": ["purpose", "texture"],
  "has_new_info": true
}`,
  getNextMessagePrompt: `?¹ì‹ ?€ ê³¡ë¬¼ ì¶”ì²œ ì±—ë´‡???ˆë‚´?ì…?ˆë‹¤. ?¬ìš©?ê? ?„ì§ ?œê³µ?˜ì? ?Šì? ?•ë³´ë¥?ë¬»ëŠ” ?œêµ­??ë©”ì‹œì§€ë¥?ë§Œë“¤??ì£¼ì„¸??

?„ì¬ ?íƒœ:
{{appState}}

?„ë½???„ë“œ:
{{missing_slots}}

ê·œì¹™
1. ?„ë½???„ë“œê°€ ?¬ëŸ¬ ê°œë©´ ?œì„œ?€ë¡?ëª©ì  ???ê° ??ê¸°í? ì§ˆë¬¸???©ë‹ˆ??
2. ?´ë? ë°›ì? ?•ë³´ë¥?ì§§ê²Œ ?”ì•½?????¤ìŒ ì§ˆë¬¸?¼ë¡œ ?ì—°?¤ëŸ½ê²??´ì–´ ê°€?¸ìš”.
3. ëª¨ë“  ?•ë³´ê°€ ëª¨ì??¤ë©´ ì¶”ì²œ??ì¤€ë¹„í•˜ê² ë‹¤??ì§§ì? ?•ì¸ ë©”ì‹œì§€ë¥?ì¶œë ¥?©ë‹ˆ??`,
  getResultFormatterPrompt: `?¹ì‹ ?€ 'ê²°ê³¼ ?¬ë§·???…ë‹ˆ?? ?„ë˜ JSON ì¶”ì²œ ê²°ê³¼?€ ?¬ìš©???•ë³´ë¥?ë°›ì•„ ?½ê¸° ì¢‹ì? ?œêµ­??ë§ˆí¬?¤ìš´ ?ìŠ¤?¸ë¡œ ë³€?˜í•˜?¸ìš”.

- ì¶”ì²œ ê²°ê³¼: {{recommendation}}
- ?¬ìš©???¤ë¬¸: {{survey}}
- ë³´ìœ  ê³¡ë¬¼: {{own_grains}}

ê·œì¹™
1. "### ë§ì¶¤ ?¡ê³¡ ë¸”ë Œ?? ?œëª©?¼ë¡œ ?œì‘?©ë‹ˆ??
2. ëª©ì /?ê° ?”ì•½, ì¶”ì²œ ëª¨ë“œ ?¤ëª…, ë°°í•© ?? ì¶”ì²œ ?´ìœ  ëª©ë¡???œì„œ?€ë¡??œê³µ?©ë‹ˆ??
3. ê¸°í”¼ ê³¡ë¬¼???ˆë‹¤ë©??´ë‹¹ ê³¡ë¬¼???œì™¸?ˆìŒ???¸ê¸‰?©ë‹ˆ??
4. ë§ˆì?ë§‰ì— ì¹œì ˆ??ë§ˆë¬´ë¦?ë¬¸ì¥??ì¶”ê??©ë‹ˆ??`,
};

const PROMPT_KEY = 'prompts';
const promptsFilePath = path.join(process.cwd(), 'lib', 'prompts.json');
const isVercel = process.env.VERCEL_ENV !== undefined;

let promptCache: Record<string, string> | null = null;

export function invalidatePromptCache() {
  promptCache = null;
}

export async function getAllPromptTemplates(): Promise<Record<string, string>> {
  if (promptCache) {
    return promptCache;
  }

  const loadDefaultsFromFile = async () => {
    try {
      const fileContent = await fs.readFile(promptsFilePath, 'utf-8');
      return JSON.parse(fileContent);
    } catch (e) {
      console.warn("prompts.json not found, using internal defaults. Saving defaults to file.");
      try {
        await fs.writeFile(promptsFilePath, JSON.stringify(defaultPrompts, null, 2), 'utf-8');
      } catch (writeError) {
        console.error("Failed to write default prompts file:", writeError);
      }
      return defaultPrompts;
    }
  };

  try {
    if (isVercel) {
      const storedPrompts = await kv.get<Record<string, string>>(PROMPT_KEY);
      if (storedPrompts && Object.keys(storedPrompts).length > 0) {
        promptCache = storedPrompts;
        return storedPrompts;
      } else {
        const defaults = await loadDefaultsFromFile();
        await kv.set(PROMPT_KEY, defaults); // Initialize KV store if empty
        promptCache = defaults;
        return defaults;
      }
    } else {
      const filePrompts = await loadDefaultsFromFile();
      promptCache = filePrompts;
      return filePrompts;
    }
  } catch (error) {
    console.error("Error fetching prompts, falling back to internal defaults:", error);
    promptCache = defaultPrompts;
    return defaultPrompts;
  }
}

async function getPrompt(key: 'getChatPrompt' | 'getRecommendationPrompt' | 'getOptimizerPrompt' | 'getExtractorPrompt' | 'getNextMessagePrompt' | 'getResultFormatterPrompt'): Promise<string> {
    const templates = await getAllPromptTemplates();
    const template = templates[key];
    if (!template) {
        throw new Error(`Prompt template for key "${key}" not found.`);
    }
    return template;
}

export async function getChatPrompt(message: string, appState: AppState): Promise<string> {
  const template = await getPrompt('getChatPrompt');
  console.log("Chat Prompt message:", message);
  return template
    .replace('{{message}}', message)
    .replace('{{appState}}', JSON.stringify(appState, null, 2));
}

export async function getRecommendationPrompt(appState: AppState): Promise<string> {
  const template = await getPrompt('getRecommendationPrompt');
  return template.replace('{{appState}}', JSON.stringify(appState, null, 2));
}

export async function getOptimizerPrompt(prompt: string): Promise<string> {
    const template = await getPrompt('getOptimizerPrompt');
    return template.replace('{{prompt}}', prompt);
}

export async function getExtractorPrompt(message: string, appState: AppState): Promise<string> {
  const template = await getPrompt('getExtractorPrompt');
  return template
    .replace('{{message}}', message)
    .replace('{{appState}}', JSON.stringify(appState, null, 2));
}

export async function getNextMessagePrompt(missing_slots: string[], appState: AppState): Promise<string> {
  const template = await getPrompt('getNextMessagePrompt');
  return template
    .replace('{{missing_slots}}', JSON.stringify(missing_slots))
    .replace('{{appState}}', JSON.stringify(appState, null, 2));
}

export async function getResultFormatterPrompt(recommendation: Recommendation, survey: SurveyState, own_grains: string[]): Promise<string> {
    const template = await getPrompt('getResultFormatterPrompt');
    return template
        .replace('{{recommendation}}', JSON.stringify(recommendation, null, 2))
        .replace('{{survey}}', JSON.stringify(survey, null, 2))
        .replace('{{own_grains}}', JSON.stringify(own_grains));
}
- \`avoid_or_allergy\`: ê¸°í”¼ ê³¡ë¬¼ ë°°ì—´ (?? ["ë³´ë¦¬"])
- \`own_grains\`: ë³´ìœ  ê³¡ë¬¼ ë°°ì—´
